% Tracing layers in MIMO
%
% TJ Young
% 10.10.2016

%% 0. Load imagery file
load('array2d_20140506-1813_attended.mat')

% Define 3-dimensional variables
xx = xxPix;%repmat([-50:49],641,1);
yy = repmat(Rs',1,100);
zz = pp_slicey;

% Plot unaltered profile
plotimgprofile_gland(xx,yy,zz);
title(['Vertical 2D profile (x-direction) at Date/Time: ', datestr(dateStamp)])

%% Filter profile

cfg.filter = 1; % Switch to filter/smooth profile
cfg.ftype = 'gaussian'; % Rotationally symmetric Gaussian lowpass filter
cfg.fsize = 7; % Filter size
cfg.fsigma = 1; % Standard deviation threshold

% Apply filters to remove noise
if cfg.filter
    filt = (fspecial(cfg.ftype,cfg.fsize,cfg.fsigma)); % Guassian lowpass filter 
    thres = (max([min(max(zz,[],1))  min(max(zz,[],2))])) ;
    zz = medfilt2(zz,[3,3]); % Median filtering in 2 directions
    zz = conv2(zz,filt,'same'); % 2-D convolution with designed filter
end

%% Identify peaks in 1D --> 2D

cfg.thresh = -50; % Power threshold for peaks

% Pre-allocate arrays
int.pks = nan(size(xx)); int.locs = int.pks;

% Find all peaks
for ii = 1:size(xx,2)
    vec = zz(:,ii); % Depth vector of power
    [pks,locs] = findpeaks(vec,'minPeakHeight',db2mag(cfg.thresh)); % Identify peaks
    for jj = 1:length(pks)
        int.pks(jj,ii) = pks(jj);
        int.locs(jj,ii) = locs(jj);
    end
end

% Re-size array to original dimensions
xxPk = nan(size(xx)); yyPk = xxPk; zzPk = xxPk;
for ii = 1:size(xx,2)
    for jj = 1:size(xx,1);
        if ismember(jj,int.locs(:,ii))
            xxPk(jj,ii) = xx(jj,ii);
            yyPk(jj,ii) = yy(jj,ii);
            zzPk(jj,ii) = zz(jj,ii);
        end
    end
end

% Plotting fancies
plotimgprofile_gland(xx,yy,zz);
plot3(xxPk,yyPk,zzPk,'k.')

%% Identify connected components (layers)
BW = binary(zzPk);

%CC = bwconncomp(


%% SCRATCH

% Identify 2D maxima
thresh = -50;
[zmax,imax,~,~]= extrema2(zz);
zmax = zmax(db(zmax) > thresh);
imax = imax(db(zmax) > thresh);

% Convert indexing to [x,y]
[imax.x,imax.y] = ind2sub(size(zz),imax);
%imax(:,1) = tmp.x; imax(:,2) = tmp.y;

pt = 90;

% Plotting fancies
plotimgprofile_gland(xx,yy,zz);
for ii = 1:length(zmax)
plot3(xx(imax.x(ii),imax.y(ii)),yy(imax.x(ii),imax.y(ii)),zmax(ii),'k.')
end
plot3(xx(imax.x(pt),imax.y(pt)),yy(imax.x(pt),imax.y(pt)),zmax(pt),'k*')

